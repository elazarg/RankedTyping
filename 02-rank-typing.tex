\section{Graded \textsf{Any} Type System}
\label{sec:types}

We factor path-insensitivity at control-flow joins into a lightweight, \emph{grade}-annotated type algebra. Grades are \emph{static} metadata; runtime values are unannotated. Intuitively, a grade increases exactly when the analysis must \emph{commit to a base after imprecision}—i.e., when downcasting from $\Any$ to a concrete base via subtyping. Heterogeneous joins themselves do not raise the grade.

\paragraph{Indices and intuition.}
Grades range over $\mathbb{N}=\{0,1,2,\dots\}$, with two distinguished symbols:
a formal bottom $\bot$ used only by $\Any^{\bot}$, and an absorbing top $\infty$ used only by $\Any^{\infty}$.
Base literals appear at grade $0$.
We extend $\max$ by $\max(\bot,j)=j$ for $j\in\mathbb{N}$ (and never apply $+1$ to $\bot$ or $\infty$).

\begin{figure}[t]
\centering
\[
\begin{array}{rcll}
i &::=& 0 \mid 1 \mid 2 \mid \cdots & \text{(finite grades)}\\[2pt]
X &::=& \Int \mid \String \mid \Bool & \text{(base types)}\\[2pt]
\tau &::=& X^{i} \mid \Any^{i} \mid \Any^{\bot} \mid \Any^{\infty} & \text{(graded types)}
\end{array}
\]
\vspace{-2mm}
\caption{Syntax of graded types.}
\label{fig:syntax}
\end{figure}

\paragraph{Subtyping.}
Subtyping is the least reflexive–transitive relation generated by the rules in Fig.~\ref{fig:subtyping}. Intuitively, $\Any^{i}$ is the bottom of grade $i$; moving from grade $i$ to $i{+}1$ reflects a \emph{downcast assumption} to a concrete base; $\Any^{\infty}$ is an absorbing top; and $\Any^{\bot}$ seeds grade~$0$.

\begin{figure}[t]
\centering
\begin{mathpar}
\inferrule*[right=(grade)]
  { }
  { X^{i} \;\le\; \Any^{i} }\quad(i\in\mathbb{N})
\qquad
\inferrule*[right=(Step)]
  { }
  { \Any^{i} \;\le\; X^{i+1} }\quad(i\in\mathbb{N})
\end{mathpar}
\vspace{-3mm}
\caption{Generating rules for subtyping ($X\in\{\Int,\String,\Bool\}$).}
\label{fig:subtyping}
\end{figure}

\paragraph{Join (\texorpdfstring{$\sqcup$}{sqcup}).}
$\sqcup$ is the least upper bound w.r.t.\ $\le$.
Its definition proceeds by \emph{promotion to a common grade} followed by a same-grade join (Fig.~\ref{fig:join}).

\begin{figure}[t]
\centering
\textbf{Promotion to common grade.}
Define $\rank(\Any^{\bot}){=}\bot$, $\rank(\Any^{i}){=}i$, $\rank(X^{i}){=}i$, $\rank(\Any^{\infty}){=}\infty$.
For $\tau_1,\tau_2$ with finite grades or $\bot$, set $r=\max(\rank(\tau_1),\rank(\tau_2))$ and let
\[
\uparrow^{r}(\tau) \;=\;
\begin{cases}
\tau & \text{if } \rank(\tau)=r,\\
\Any^{r} & \text{if } \rank(\tau)<r\text{ (promote to least supertype at grade $r$).}
\end{cases}
\]
(If any operand is $\Any^{\infty}$, the join is $\Any^{\infty}$.)

\medskip
\textbf{Same-grade join (at grade $r\in\mathbb{N}$).}
For $X,Y\in\{\Int,\String,\Bool\}$ and $Z\in\{\Any,\Int,\String,\Bool\}$:
\[
\begin{array}{r@{\quad=\quad}l@{\qquad}l}
X^{r} \sqcup X^{r} & X^{r} & \text{(idempotence)}\\
X^{r} \sqcup Y^{r} & \Any^{r} & (X\neq Y)\ \text{(heterogeneous merge; no bump)}\\
\Any^{r} \sqcup Z^{r} & \Any^{r} & \text{(absorption)}\\
\end{array}
\]
\medskip
\textbf{Full definition.}
\[
\tau_1 \sqcup \tau_2 \;=\;
\begin{cases}
\Any^{\infty} & \text{if }\tau_1=\Any^{\infty}\text{ or }\tau_2=\Any^{\infty},\\
\uparrow^{r}(\tau_1)\ \sqcup\ \uparrow^{r}(\tau_2) & \text{where } r=\max(\rank(\tau_1),\rank(\tau_2)).
\end{cases}
\]
\vspace{-1mm}
\caption{Join: promote to a common grade, then same-grade join.}
\label{fig:join}
\end{figure}

\paragraph{Derived laws.}
For all $i\le j$ in $\mathbb{N}$ and $X\in\{\Int,\String,\Bool\}$:
\begin{align*}
&\textbf{Monotone grades:} && \Any^{i} \le \Any^{j},\quad X^{i} \le X^{j}.\\
&\textbf{Absorption (same grade):} && \Any^{i} \sqcup \tau^{i} = \Any^{i}.\\
&\textbf{Cross-grade absorption:} && \Any^{i} \sqcup \tau^{j} = \Any^{\max(i,j)}\quad(\text{with }\max(\bot,j)=j).\\
&\textbf{Heterogeneous same-grade merge:} && X^{i} \sqcup Y^{i}=\Any^{i}\ (X\neq Y).\\
&\textbf{Top absorption:} && \tau \sqcup \Any^{\infty}=\Any^{\infty}.\\
&\textbf{ACI of join:} && \text{$\sqcup$ is associative, commutative, idempotent.}
\end{align*}

\paragraph{Reading grades.}
With $\Any^{\bot}$ as a formal bottom, a finite grade $k\ge 0$ records the number of \emph{downcast assumptions} (steps of $\Any^{i}\le X^{i+1}$) witnessed so far along the abstract flow.
Once at $\Any^{k}$, further joins at grade $\le k$ do not escalate the grade; escalation requires a new downcast at or above grade $k$.

\medskip
This section defines only the graded type algebra.
The language and its abstract interpreter (expressions, statements, \textsf{while}) appear in the next section.

\paragraph*{Notation.}
We write $\Int,\String,\Bool,\Any$ in \textsf{sans} and use
$\rank(\cdot)$ and $\uparrow^{r}(\cdot)$ as defined above.
Include \texttt{mathpartir} for the inference rules.
