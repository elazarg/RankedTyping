\section{Ranked \textsf{Any} Type System}
\label{sec:types}

We factor path-insensitivity at control-flow joins into a lightweight, rank-annotated type algebra. Ranks are \emph{static} metadata; runtime values are unannotated. Intuitively, a rank increases exactly when the analysis must perform a lossy same-rank merge of incompatible base types.

\paragraph{Indices and intuition.}
Ranks range over $\mathbb{N}=\{0,1,2,\dots\}$, with two distinguished symbols:
a formal bottom $\bot$ used only by $\Any^{\bot}$, and an absorbing top $\infty$ used only by $\Any^{\infty}$.
Base literals appear at rank $0$.
We extend $\max$ by $\max(\bot,j)=j$ for $j\in\mathbb{N}$ (and never apply $+1$ to $\bot$ or $\infty$).

\begin{figure}[t]
\centering
\[
\begin{array}{rcll}
i &::=& 0 \mid 1 \mid 2 \mid \cdots & \text{(finite ranks)}\\[2pt]
X &::=& \Int \mid \String \mid \Bool & \text{(base types)}\\[2pt]
\tau &::=& X^{i} \mid \Any^{i} \mid \Any^{\bot} \mid \Any^{\infty} & \text{(ranked types)}
\end{array}
\]
\vspace{-2mm}
\caption{Syntax of ranked types.}
\label{fig:syntax}
\end{figure}

\paragraph{Subtyping.}
Subtyping is the least reflexiveâ€“transitive relation generated by the rules in Fig.~\ref{fig:subtyping}. Intuitively, $\Any^{i}$ is the bottom of rank $i$; moving from rank $i$ to $i{+}1$ forgets shape; $\Any^{\infty}$ is an absorbing top; and $\Any^{\bot}$ seeds rank~$0$.

\begin{figure}[t]
\centering
\begin{mathpar}
\inferrule*[right=(rank)]
  { }
  {  X^{i} \;\le\; \Any^{i} }\quad(i\in\mathbb{N})
\inferrule*[right=(Step)]
  { }
  { \Any^{i} \;\le\;  X^{i+1}}\quad(i\in\mathbb{N})
\end{mathpar}
\vspace{-3mm}
\caption{Generating rules for subtyping ($X\in\{\Int,\String,\Bool\}$).}
\label{fig:subtyping}
\end{figure}

\paragraph{Join (\texorpdfstring{$\sqcup$}{sqcup}).}
$\sqcup$ is the least upper bound w.r.t.\ $\le$.
Its definition proceeds by \emph{promotion to a common rank} followed by a same-rank join (Fig.~\ref{fig:join}).

\begin{figure}[t]
\centering
\textbf{Promotion to common rank.}
Define $\rank(\Any^{\bot}){=}\bot$, $\rank(\Any^{i}){=}i$, $\rank(X^{i}){=}i$, $\rank(\Any^{\infty}){=}\infty$.
For $\tau_1,\tau_2$ with finite ranks or $\bot$, set $r=\max(\rank(\tau_1),\rank(\tau_2))$ and let
\[
\uparrow^{r}(\tau) \;=\;
\begin{cases}
\tau & \text{if } \rank(\tau)=r,\\
\Any^{r} & \text{if } \rank(\tau)<r\text{ (promote to least supertype at rank $r$).}
\end{cases}
\]
(If any operand is $\Any^{\infty}$, the join is $\Any^{\infty}$.)

\medskip
\textbf{Same-rank join (at rank $r\in\mathbb{N}$).}
For $X,Y\in\{\Int,\String,\Bool\}$ and $Z\in\{\Any,\Int,\String,\Bool\}$:
\[
\begin{array}{r@{\quad=\quad}l@{\qquad}l}
X^{r} \sqcup X^{r} & X^{r} & \text{(idempotence)}\\
X^{r} \sqcup Y^{r} & \Any^{r+1} & (X\neq Y)\ \text{(heterogeneous merge)}\\
\Any^{r} \sqcup Z^{r} & \Any^{r} & \text{(absorption)}\\
\end{array}
\]
\medskip
\textbf{Full definition.}
\[
\tau_1 \sqcup \tau_2 \;=\;
\begin{cases}
\Any^{\infty} & \text{if }\tau_1=\Any^{\infty}\text{ or }\tau_2=\Any^{\infty},\\
\uparrow^{r}(\tau_1)\ \sqcup\ \uparrow^{r}(\tau_2) & \text{where } r=\max(\rank(\tau_1),\rank(\tau_2)).
\end{cases}
\]
\vspace{-1mm}
\caption{Join: promote to a common rank, then same-rank join.}
\label{fig:join}
\end{figure}

\paragraph{Derived laws.}
For all $i\le j$ in $\mathbb{N}$ and $X\in\{\Int,\String,\Bool\}$:
\begin{align*}
&\textbf{Monotone ranks:} && \Any^{i} \le \Any^{j},\quad X^{i} \le X^{j}.\\
&\textbf{Absorption (same rank):} && \Any^{i} \sqcup \tau^{i} = \Any^{i}.\\
&\textbf{Cross-rank absorption:} && \Any^{i} \sqcup \tau^{j} = \Any^{\max(i,j)}\quad(\text{with }\max(\bot,j)=j).\\
&\textbf{Heterogeneous same-rank merge:} && X^{i} \sqcup Y^{i}=\Any^{i+1}\ (X\neq Y).\\
&\textbf{Top absorption:} && \tau \sqcup \Any^{\infty}=\Any^{\infty}.\\
&\textbf{ACI of join:} && \text{$\sqcup$ is associative, commutative, idempotent.}
\end{align*}

\paragraph{Reading ranks.}
With $\Any^{\bot}$ as a formal bottom, a finite rank $k\ge 0$ records the number of lossy, same-rank heterogeneous merges witnessed so far.
Once at $\Any^{k}$, further joins at rank $\le k$ do not escalate the rank; escalation requires a new heterogeneous merge \emph{at rank $k$}.

\medskip
This section defines only the ranked type algebra.
The language and its abstract interpreter (expressions, statements, \textsf{while}) appear in the next section.

\paragraph*{Notation.}
We write $\Int,\String,\Bool,\Any$ in \textsf{sans} and use
$\rank(\cdot)$ and $\uparrow^{r}(\cdot)$ as defined above.
Include \texttt{mathpartir} for the inference rules.
