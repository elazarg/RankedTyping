
\section{The \textsf{Graded} Type System}
\label{sec:types}

We factor path-insensitivity at control-flow joins into a lightweight, \emph{grade}-annotated type algebra. Grades are \emph{static} metadata; runtime values are unannotated. Intuitively, a grade increases exactly when the analysis must \emph{commit to a base after imprecision}; i.e., when downcasting from $\Any$ to a concrete base via subtyping. Heterogeneous joins themselves do not raise the grade.

\paragraph{Indices and intuition.}
Grades range over $\mathbb{N}=\{0,1,2,\dots\}$, with two distinguished symbols:
a formal bottom $\bot$ used only by $\Any^{\bot}$, and an absorbing top $\infty$ used only by $\Any^{\infty}$.
Base literals appear at grade $0$.
We extend $\max$ by $\max(\bot,j)=j$ for $j\in\mathbb{N}$ (and never apply $+1$ to $\bot$ or $\infty$).

\begin{figure}[t]
\centering
\[
\begin{array}{rcll}
i &::=& 0 \mid 1 \mid 2 \mid \cdots & \text{(finite grades)}\\[2pt]
X &::=& \Int \mid \String \mid \Bool & \text{(base types)}\\[2pt]
\tau &::=& X^{i} \mid \Any^{i} \mid \Any^{\bot} \mid \Any^{\infty} & \text{(graded types)}
\end{array}
\]
\vspace{-2mm}
\caption{Syntax of graded types.}
\label{fig:syntax}
\end{figure}

\begin{figure}[ht]
\centering
\begin{tikzpicture}[
    node distance=0.8cm and 1cm,
    base/.style={circle, draw, inner sep=2pt},
    any/.style={rectangle, draw, inner sep=3pt}
]
    % Grade k (Top)
    \node (anyk) [any] {$\Any^k$};
    \node (intk) [base, below left=of anyk] {$\Int^k$};
    \node (strk) [base, below=of anyk] {$\String^k$};
    \node (boolk) [base, below right=of anyk] {$\Bool^k$};
    
    \draw[-latex] (intk) -- (anyk);
    \draw[-latex] (strk) -- (anyk);
    \draw[-latex] (boolk) -- (anyk);

    % Ellipsis
    \node (vdots) [below=of strk, yshift=0.5cm] {\vdots};

    % Grade 1
    \node (any1) [any, below=of vdots, yshift=0.5cm] {$\Any^1$};
    \node (int1) [base, below left=of any1] {$\Int^1$};
    \node (str1) [base, below=of any1] {$\String^1$};
    \node (bool1) [base, below right=of any1] {$\Bool^1$};

    \draw[-latex] (int1) -- (any1);
    \draw[-latex] (str1) -- (any1);
    \draw[-latex] (bool1) -- (any1);
    
    % Connections from rank k-1 to k
    \path (vdots) edge[-latex] (intk);
    \path (vdots) edge[-latex] (strk);
    \path (vdots) edge[-latex] (boolk);

    % Grade 0
    \node (any0) [any, below=of str1] {$\Any^0$};
    \node (int0) [base, below left=of any0] {$\Int^0$};
    \node (str0) [base, below=of any0] {$\String^0$};
    \node (bool0) [base, below right=of any0] {$\Bool^0$};

    \draw[-latex] (int0) -- (any0);
    \draw[-latex] (str0) -- (any0);
    \draw[-latex] (bool0) -- (any0);
    
    % Connections from rank 0 to 1
    \draw[-latex] (any0) -- (int1);
    \draw[-latex] (any0) -- (str1);
    \draw[-latex] (any0) -- (bool1);
    
    \node (anybot) [any, below=of str0] {$\Any^{\bot}$};
    
    \draw[-latex] (anybot) -- (int0);
    \draw[-latex] (anybot) -- (str0);
    \draw[-latex] (anybot) -- (bool0);
\end{tikzpicture}
\caption[Hasse diagram of the graded type lattice]%
{Hasse diagram of the graded type lattice. Each rank $i$ consists of base types below $\Any^i$. 
The ranks are connected by the subtyping rule $\Any^i \le X^{i+1}$, forming a vertical chain.}
\label{fig:hassediagram}
\end{figure}

\paragraph{Subtyping.}
Subtyping is the least reflexiveâ€“transitive relation generated by the rules in Fig.~\ref{fig:subtyping}. Intuitively, $\Any^{i}$ is the bottom of grade $i$; moving from grade $i$ to $i{+}1$ reflects a \emph{downcast assumption} to a concrete base; $\Any^{\infty}$ is an absorbing top; and $\Any^{\bot}$ seeds grade~$0$.

\begin{figure}[t]
\centering
\begin{mathpar}
\inferrule*[right=(grade)]
  { }
  { X^{i} \;\le\; \Any^{i} }\quad(i\in\mathbb{N})
\qquad
\inferrule*[right=(Step)]
  { }
  { \Any^{i} \;\le\; X^{i+1} }\quad(i\in\mathbb{N})
\end{mathpar}
\vspace{-3mm}
\caption{Generating rules for subtyping ($X\in\{\Int,\String,\Bool\}$).}
\label{fig:subtyping}
\end{figure}

\paragraph{Join (\texorpdfstring{$\sqcup$}{sqcup}).}
$\sqcup$ is the least upper bound w.r.t.\ $\le$.
Its definition proceeds by \emph{promotion to a common grade} followed by a same-grade join (Fig.~\ref{fig:join}).

\begin{figure}[t]
\centering
\textbf{Promotion to common grade.}
Define $\grade(\Any^{\bot}){=}\bot$, $\grade(\Any^{i}){=}i$, $\grade(X^{i}){=}i$, $\grade(\Any^{\infty}){=}\infty$.
For $\tau_1,\tau_2$ with finite grades or $\bot$, set $r=\max(\grade(\tau_1),\grade(\tau_2))$ and let
\[
\uparrow^{r}(\tau) \;=\;
\begin{cases}
\tau & \text{if } \grade(\tau)=r,\\
\Any^{r} & \text{if } \grade(\tau)<r\text{ (promote to least supertype at grade $r$).}
\end{cases}
\]
(If any operand is $\Any^{\infty}$, the join is $\Any^{\infty}$.)

\medskip
\textbf{Same-grade join (at grade $r\in\mathbb{N}$).}
For $X,Y\in\{\Int,\String,\Bool\}$ and $Z\in\{\Any,\Int,\String,\Bool\}$:
\[
\begin{array}{r@{\quad=\quad}l@{\qquad}l}
X^{r} \sqcup X^{r} & X^{r} & \text{(idempotence)}\\
X^{r} \sqcup Y^{r} & \Any^{r} & (X\neq Y)\ \text{(heterogeneous merge; no bump)}\\
\Any^{r} \sqcup Z^{r} & \Any^{r} & \text{(absorption)}\\
\end{array}
\]
\medskip
\textbf{Full definition.}
\[
\tau_1 \sqcup \tau_2 \;=\;
\begin{cases}
\Any^{\infty} & \text{if }\tau_1=\Any^{\infty}\text{ or }\tau_2=\Any^{\infty},\\
\uparrow^{r}(\tau_1)\ \sqcup\ \uparrow^{r}(\tau_2) & \text{where } r=\max(\grade(\tau_1),\grade(\tau_2)).
\end{cases}
\]
\vspace{-1mm}
\caption{Join: promote to a common grade, then same-grade join.}
\label{fig:join}
\end{figure}

\paragraph{Derived laws.}
For all $i\le j$ in $\mathbb{N}$ and $X\in\{\Int,\String,\Bool\}$:
\begin{align*}
&\textbf{Monotone grades:} && \Any^{i} \le \Any^{j},\quad X^{i} \le X^{j}.\\
&\textbf{Absorption (same grade):} && \Any^{i} \sqcup \tau^{i} = \Any^{i}.\\
&\textbf{Cross-grade absorption:} && \Any^{i} \sqcup \tau^{j} = \Any^{\max(i,j)}\quad(\text{with }\max(\bot,j)=j).\\
&\textbf{Heterogeneous same-grade merge:} && X^{i} \sqcup Y^{i}=\Any^{i}\ (X\neq Y).\\
&\textbf{Top absorption:} && \tau \sqcup \Any^{\infty}=\Any^{\infty}.\\
&\textbf{ACI of join:} && \text{$\sqcup$ is associative, commutative, idempotent.}
\end{align*}

\paragraph{Reading grades.}
With $\Any^{\bot}$ as a formal bottom, a finite grade $k\ge 0$ records the number of \emph{downcast assumptions} (steps of $\Any^{i}\le X^{i+1}$) witnessed so far along the abstract flow.
Once at $\Any^{k}$, further joins at grade $\le k$ do not escalate the grade; escalation requires a new downcast at or above grade $k$.
By convention, $\Any^{0}$ denotes imprecision \emph{without any forced assumption yet}:
merging heterogeneous bases at a join yields $\Any^{0}$ (after promotion), but grades increase only when a base is \emph{demanded} and a downcast $\Any^{i}\le X^{i+1}$ is taken.
Thus joins alone do not raise grades; uses that require a base do.

\medskip
This section defines only the graded type algebra.
The language and its abstract interpreter (expressions, statements, \textsf{while}) appear in the next section.
